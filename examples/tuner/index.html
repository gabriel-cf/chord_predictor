<html>
<head>
    <script>
function BufferLoader(context, urlList, callback) {
  this.context = context;
  this.urlList = urlList;
  this.onload = callback;
  this.bufferList = new Array();
  this.loadCount = 0;
}

BufferLoader.prototype.loadBuffer = function(url, index) {
  // Load buffer asynchronously
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  var loader = this;

  request.onload = function() {
    // Asynchronously decode the audio file data in request.response
    loader.context.decodeAudioData(
      request.response,
      function(buffer) {
        if (!buffer) {
          alert('error decoding file data: ' + url);
          return;
        }
        loader.bufferList[index] = buffer;
        if (++loader.loadCount == loader.urlList.length)
          loader.onload(loader.bufferList);
      },
      function(error) {
        console.error('decodeAudioData error', error);
      }
    );
  }

  request.onerror = function() {
    alert('BufferLoader: XHR error');
  }

  request.send();
}

BufferLoader.prototype.load = function() {
  for (var i = 0; i < this.urlList.length; ++i)
  this.loadBuffer(this.urlList[i], i);
}


// Define the set of test frequencies that we'll use to analyze microphone data.
var C2 = 65.41; // C2 note, in Hz.
var notes = [ "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" ];
var test_frequencies = [];
for (var i = 0; i < 30; i++)
{
	var note_frequency = C2 * Math.pow(2, i / 12);
	var note_name = notes[i % 12];
	var note = { "frequency": note_frequency, "name": note_name };
	var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
	var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
	test_frequencies = test_frequencies.concat([ just_below, note, just_above ]);
}

window.addEventListener("load", initialize);

var correlation_worker = new Worker("correlation_worker.js");
correlation_worker.addEventListener("message", interpret_correlation_result);

function initialize()
{
	/*var get_user_media = navigator.getUserMedia;
	get_user_media = get_user_media || navigator.webkitGetUserMedia;
	get_user_media = get_user_media || navigator.mozGetUserMedia;
	get_user_media.call(navigator, { "audio": true }, use_stream, function() {});*/
	window.AudioContext = window.AudioContext || window.webkitAudioContext;
	var context = new AudioContext();
	var bufferLoader = new BufferLoader(
    context,
    [
      './a-open.wav'
    ],
    function(bufferList) {
			console.log(bufferList);
			var source1 = context.createBufferSource();
		  source1.buffer = bufferList[0];
		  source1.connect(context.destination);
		  source1.start(0);
			const duration = bufferList[0].duration;
			const buffer = source1.buffer.getChannelData(0);
			const nFrames = 1// duration / 0.1;
			let i = 0;
      let minIndex = 0;
      let maxIndex = 0;
			const interval = setInterval(function () {
        minIndex = maxIndex;
        maxIndex = i * Math.ceil(source1.buffer.length / nFrames);
        if (maxIndex >= source1.buffer.length) {
					clearInterval(interval);
				}
        console.log(`${minIndex} - ${maxIndex}`);
				correlation_worker.postMessage
				(
					{
						"timeseries": buffer.slice(minIndex, maxIndex),
						"test_frequencies": test_frequencies,
						"sample_rate": context.sampleRate
					}
				);
        ++i;
			}, 100);
		}
    );
	bufferLoader.load();
}

function interpret_correlation_result(event)
{
	var timeseries = event.data.timeseries;
	var frequency_amplitudes = event.data.frequency_amplitudes;

	// Compute the (squared) magnitudes of the complex amplitudes for each
	// test frequency.
	var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });

	// Find the maximum in the list of magnitudes.
	var maximum_index = -1;
	var maximum_magnitude = 0;
	for (var i = 0; i < magnitudes.length; i++)
	{
		if (magnitudes[i] <= maximum_magnitude)
			continue;

		maximum_index = i;
		maximum_magnitude = magnitudes[i];
	}

	// Compute the average magnitude. We'll only pay attention to frequencies
	// with magnitudes significantly above average.
	var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
	var dominant_frequency = test_frequencies[maximum_index];
	document.getElementById("note-name").textContent = dominant_frequency.name;
	document.getElementById("frequency").textContent = dominant_frequency.frequency;
}

    </script>
</head>

<body>
<p>It sounds like you're playing...</p>
<h1 id="note-name"></h1>
<p>
    <span>frequency (Hz):</span>
    <span id="frequency"></span>
</p>
<hr>
<button id="play-note">start/stop an E note</button>
<hr>
<a href="https://github.com/jbergknoff/guitar-tuner">Source code</a> / <a
        href="http://jonathan.bergknoff.com/journal/making-a-guitar-tuner-html5">Explanatory article</a>
</body>
</html>
